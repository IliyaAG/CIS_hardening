---
# Preliminary tasks that should always be run

- name: "PRELIM | PATCH | Ensure libselinux is installed"
  when: '"libselinux" not in ansible_facts.packages'
  tags: always
  ansible.builtin.package:
    name: libselinux
    state: present

- name: "PRELIM | AUDIT | Interactive Users"
  tags: always
  ansible.builtin.shell: >
      grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false" && $7 != "/dev/null") { print $1 }'
  changed_when: false
  check_mode: false
  register: prelim_interactive_usernames

- name: "PRELIM | AUDIT | Interactive User accounts home directories"
  tags: always
  ansible.builtin.shell: >
      grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false" && $7 != "/dev/null") { print $6 }'
  changed_when: false
  check_mode: false
  register: prelim_interactive_users_home

- name: "PRELIM | AUDIT | Interactive UIDs"
  tags: always
  ansible.builtin.shell: >
      grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false") { print $3 }'
  changed_when: false
  check_mode: false
  register: prelim_interactive_uids

- name: "PRELIM | Discover Interactive UID MIN and MIN from logins.def"
  when: discover_int_uid
  block:
    - name: "PRELIM | Capture UID_MIN information from logins.def"
      ansible.builtin.shell: grep -w "^UID_MIN" /etc/login.defs | awk '{print $NF}'
      changed_when: false
      check_mode: false
      register: prelim_uid_min_id

    - name: "PRELIM | Capture UID_MAX information from logins.def"
      ansible.builtin.shell: grep -w "^UID_MAX" /etc/login.defs | awk '{print $NF}'
      changed_when: false
      check_mode: false
      register: prelim_uid_max_id

    - name: "PRELIM | set_facts for interactive uid/gid"
      ansible.builtin.set_fact:
        min_int_uid: "{{ prelim_uid_min_id.stdout }}"
        max_int_uid: "{{ prelim_uid_max_id.stdout }}"

- name: "PRELIM | AUDIT | Set facts based on boot type"
  tags: always
  block:
    - name: "PRELIM | AUDIT | Check whether machine is UEFI-based"
      ansible.builtin.stat:
        path: /sys/firmware/efi
      register: prelim_efi_boot

    - name: "PRELIM | AUDIT | set legacy boot and grub path fact | Bios"
      when: not prelim_efi_boot.stat.exists
      ansible.builtin.set_fact:
        legacy_boot: true
        grub2_path: /etc/grub2.cfg
        boot_path: /boot/grub2/

    - name: "PRELIM | AUDIT | set grub fact | UEFI"
      when: prelim_efi_boot.stat.exists
      ansible.builtin.set_fact:
        grub2_path: /etc/grub2-efi.cfg
        boot_path: "/boot/efi/EFI/{{ ansible_facts.distribution | lower }}/"

- name: "PRELIM | AUDIT | Ensure permissions on bootloader config are configured | Get grub config file stats"
  tags: always
  ansible.builtin.stat:
    path: "{{ grub2_path }}"
  changed_when: false
  check_mode: false
  register: prelim_grub_cfg

- name: "PRELIM | AUDIT | Gather the package facts before prelim"
  tags: always
  ansible.builtin.package_facts:
    manager: auto

- name: PRELIM | Include audit specific variables
  when: run_audit or audit_only or setup_audit
  tags:
    - setup_audit
    - run_audit
  ansible.builtin.include_vars:
    file: audit.yml

- name: PRELIM | Include pre-remediation audit tasks
  when: run_audit or audit_only or setup_audit
  tags: run_audit
  ansible.builtin.import_tasks:
    file: pre_remediation_audit.yml

##### Section requirements #####
- name: "PRELIM | AUDIT | Section 1.1 | Create list of mount points"
  tags: always
  ansible.builtin.set_fact:
    mount_names: "{{ ansible_mounts | map(attribute='mount') | list }}"

- name: "PRELIM | AUDIT | Ensure /dev/shm is a separate partition | discover"
  when:
    - rule_1_1_2_2_1 or
      rule_1_1_2_2_2 or
      rule_1_1_2_2_3 or
      rule_1_1_2_2_4
  tags: always
  ansible.builtin.command: findmnt -kn /dev/shm
  changed_when: false
  failed_when: prelim_dev_shm_present.rc not in [ 0, 1 ]
  check_mode: false
  register: prelim_dev_shm_present

- name: "PRELIM | AUDIT | systemd coredump file check"
  when: rule_1_4_4
  tags: always
  ansible.builtin.stat:
    path: /etc/systemd/coredump.conf
  register: prelim_systemd_coredump

- name: "PRELIM | PATCH | Setup crypto-policy"
  when:
    - rule_1_6_1 or
      rule_1_6_2 or
      rule_1_6_3 or
      rule_1_6_4
  tags:
    - level1-server
    - level1-workstation
    - rule_1.6.1
    - rule_1.6.2
    - rule_1.6.3
    - rule_1.6.4
    - crypto
  block:
    - name: "PRELIM | PATCH | Install crypto-policies | pkgs present"
      ansible.builtin.package:
        name:
          - crypto-policies
          - crypto-policies-scripts
        state: present

    - name: "PRELIM | AUDIT | Gather system-wide crypto-policy"
      ansible.builtin.command: update-crypto-policies --show
      changed_when: false
      check_mode: false
      register: prelim_system_wide_crypto_policy

    - name: "PRELIM | AUDIT | Gather system-wide crypto-policy | set fact system policy"
      ansible.builtin.set_fact:
        current_crypto_policy: "{{ prelim_system_wide_crypto_policy.stdout.split(':')[0] }}"

    - name: "PRELIM | AUDIT | Gather system-wide crypto-policy module | set fact system policy submodule"
      when: "':' in prelim_system_wide_crypto_policy.stdout"
      ansible.builtin.set_fact:
        current_crypto_module: "{{ prelim_system_wide_crypto_policy.stdout.split(':')[1] }}"

- name: "PRELIM | PATCH | Install dconf if gui"
  when:
    - "'gdm' in ansible_facts.packages"
    - "'dconf' not in ansible_facts.packages"
    - gui
  tags: always
  ansible.builtin.package:
    name: dconf
    state: present

- name: "PRELIM | PATCH | Cron Package"
  when: "'cronie' not in ansible_facts.packages"
  tags: always
  ansible.builtin.package:
    name: cronie
    state: present

- name: "PRELIM | AUDIT | Find all sudoers files."
  when: rule_4_3_4 or rule_4_3_5
  tags: always
  ansible.builtin.command: "find /etc/sudoers /etc/sudoers.d/ -type f ! -name '*~' ! -name '*.*'"
  changed_when: false
  failed_when: false
  check_mode: false
  register: prelim_sudoers_files

- name: "PRELIM | AUDIT | Interactive User accounts home directories"
  tags: always
  ansible.builtin.shell: >
      grep -E -v '^(root|halt|sync|shutdown)' /etc/passwd | awk -F: '(!index($7, "sbin/nologin") && $7 != "/bin/nologin" && $7 != "/bin/false") { print $6 }'
  changed_when: false
  check_mode: false
  register: prelim_interactive_users_home

- name: "PRELIM | PATCH | Section 5.1 | Configure System Accounting (auditd)"
  when:
    - level_2
    - "'audit' not in ansible_facts.packages"
  tags: always
  ansible.builtin.package:
    name: audit
    state: present

- name: "PRELIM | AUDIT | 5.2.4.x | Ensure audit log files are mode 0640 or less permissive | discover file"
  when:
    - rule_5_2_4_1 or
      rule_5_2_4_2 or
      rule_5_2_4_3 or
      rule_5_2_4_4
  tags: always
  ansible.builtin.shell: "grep ^log_file /etc/audit/auditd.conf | awk '{ print $NF }'"
  changed_when: false
  failed_when: prelim_audit_logfile.rc not in [0, 1]
  register: prelim_audit_logfile

- name: "PRELIM | AUDIT | 5.2.4.5/6/7 | Audit conf and rules files | list files"
  when:
    - rule_5_2_4_5 or
      rule_5_2_4_6 or
      rule_5_2_4_7
  tags:
    - level2-server
    - level2-workstation
    - patch
    - auditd
    - rule_5.2.4.5
    - rule_5.2.4.6
    - rule_5.2.4.7
  ansible.builtin.find:
    path: /etc/audit
    file_type: file
    recurse: true
    patterns: '*.conf,*.rules'
  register: prelim_auditd_conf_files

- name: "PRELIM | AUDIT | Check if auditd is immutable before changes"
  when: "'auditd' in ansible_facts.packages"
  tags: always
  ansible.builtin.shell: auditctl -l | grep -c '-e 2'
  changed_when: false
  check_mode: false
  failed_when: prelim_auditd_immutable_check.rc not in [ 0, 1 ]
  register: prelim_auditd_immutable_check

- name: "PRELIM | AUDIT | Gather UID 0 accounts other than root"
  when: rule_6_2_9
  tags:
    - rule_6.2.9
    - level1-server
    - level1-workstation
    - users
  ansible.builtin.shell: "cat /etc/passwd | awk -F: '($3 == 0 && $1 != \"root\") {i++;print $1 } END {exit 1}'"
  failed_when: prelim_uid_zero_accounts_except_root.rc not in [ 0, 1 ]
  changed_when: false
  check_mode: false
  register: prelim_uid_zero_accounts_except_root

##### Optional #####

# Added to ensure ssh drop in file exists if not default /etc/ssh/sshd_config
- name: "PRELIM | PATCH | SSH Config file is not exist"
  when:
    - sshd_config_file != '/etc/ssh/sshd_config'
    - "'openssh-server' in ansible_facts.packages"
  tags:
    - always
    - level1_server
    - level1_workstation
  block:
    - name: "PRELIM | AUDIT | Check SSH Config drop in is supported for distribution version"
      ansible.builtin.assert:
        that: ansible_distribution_version is version_compare('8.6', '>=')
        fail_msg: "{{ ansible_distribution }} {{ ansible_distribution_version }} does not support SSH Config drop in"

    - name: "PRELIM | PATCH | SSH Config drop in directory is not exist"
      ansible.builtin.file:
        path: "{{ sshd_config_file | dirname }}"
        owner: root
        group: root
        mode: 'go-rwx'
        state: directory

    - name: "PRELIM | PATCH | SSH Config file is not exist"
      ansible.builtin.file:
        path: "{{ sshd_config_file }}"
        owner: root
        group: root
        mode: 'go-rwx'
        state: touch

- name: "PRELIM | Optional | If IPv6 disable to stop ssh listening"
  when:
    - ipv6_sshd_disable
    - not ipv6_required
  tags: always
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: ^AddressFamily
    line: AddressFamily inet
  notify: Restart_sshd

- name: "PRELIM | Optional | If IPv6 disable to stop chronyd listening"
  when:
    - ipv6_chrony_disable
    - not ipv6_required
  tags: always
  notify: Restart_chronyd
  block:
    - name: "PRELIM | Optional | If IPv6 disable to stop chronyd listening | Check existence"
      ansible.builtin.shell: grep -E "OPTIONS=.*-4" /etc/sysconfig/chronyd
      changed_when: false
      failed_when: prelim_chrony_ipv6_exists.rc not in [ 0, 1]
      check_mode: false
      register: prelim_chrony_ipv6_exists

    - name: "PRELIM | Optional | If IPv6 disable to stop chronyd listening"
      when: prelim_chrony_ipv6_exists.stdout | length == 0
      ansible.builtin.lineinfile:
        path: /etc/sysconfig/chronyd
        regexp: '^OPTIONS="(?!.* -4.*)(.*)"'
        line: OPTIONS="\1 -4"
        backrefs: true

# Optional extra keys to extend auditd not part of CIS but can influence a system
# e.g. admin_space_left: '10%'

- name: PRELIM | Optional | Configure other keys for auditd.conf
  when:
    - auditd_extra_conf.keys() | length > 0
    - level_2
  tags: always
  ansible.builtin.lineinfile:
    path: /etc/audit/auditd.conf
    regexp: "^{{ item }}( |=)"
    line: "{{ item }} = {{ auditd_extra_conf[item] }}"
  notify: Restart auditd
  loop: "{{ auditd_extra_conf.keys() }}"
