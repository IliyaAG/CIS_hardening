---

- name: "1.6.1 | PATCH | Ensure system-wide crypto policy is not legacy"
  when: rule_1_6_1
  tags:
    - level1-server
    - level1-workstation
    - automated
    - patch
    - crypto
    - NIST800-53R5_SC-8
    - rule_1.6.1
  ansible.builtin.debug:
    msg: "Captured in prelim to ensure not LEGACY. Runs handler to update"
  notify:
    - Update_Crypto_Policy
    - Set_Crypto_Policy

- name: "1.6.2 | PATCH | Ensure system wide crypto policy disables sha1 hash and signature support"
  when:
    - rule_1_6_2
    - "'NO-SHA1' not in crypto_policy_module"
  tags:
    - level1-server
    - level1-workstation
    - automated
    - patch
    - crypto
    - NIST800-53R5_SC-8
    - rule_1.6.2
  block:
    - name: "1.6.2 | PATCH | Ensure system wide crypto policy disables sha1 hash and signature support"
      ansible.builtin.template:
        src: etc/crypto-policies/policies/modules/NO-SHA1.pmod.j2
        dest: /etc/crypto-policies/policies/modules/NO-SHA1.pmod
        owner: root
        group: root
        mode: 'u-x,g-wx,o-rwx'
      register: discovered_no_sha1_template

    - name: "1.6.2 | PATCH | Ensure system wide crypto policy disables sha1 hash and signature support | submodule to crypto policy modules"
      ansible.builtin.set_fact:
        crypto_policy_module: "{{ crypto_policy_module + ':' + 'NO-SHA1' }}"
      changed_when: discovered_no_sha1_template is changed # noqa: no-handler
      notify:
        - Update_Crypto_Policy
        - Set_Crypto_Policy

- name: "1.6.3 | PATCH | Ensure system wide crypto policy disables cbc for ssh"
  when:
    - rule_1_6_3
    - "'NO-SSHCBC' not in crypto_policy_module"
  tags:
    - level1-server
    - level1-workstation
    - automated
    - patch
    - crypto
    - NIST800-53R5_SC-8
    - rule_1.6.3
  block:
    - name: "1.6.3 | PATCH | Ensure system wide crypto policy disables cbc for ssh | Add submodule exclusion"
      ansible.builtin.template:
        src: etc/crypto-policies/policies/modules/NO-SSHCBC.pmod.j2
        dest: /etc/crypto-policies/policies/modules/NO-SSHCBC.pmod
        owner: root
        group: root
        mode: 'u-x,g-wx,o-rwx'
      register: discovered_no_sshcbc_template

    - name: "1.6.3 | PATCH | Ensure system wide crypto policy disables cbc for ssh | submodule to crypto policy modules"
      ansible.builtin.set_fact:
        crypto_policy_module: "{{ crypto_policy_module + ':' + 'NO-SSHCBC' }}"
      changed_when: discovered_no_sshcbc_template is changed # noqa: no-handler
      notify:
        - Update_Crypto_Policy
        - Set_Crypto_Policy

- name: "1.6.4 | PATCH | Ensure system wide crypto policy disables macs less than 128 bits"
  when:
    - rule_1_6_4
    - "'NO-WEAKMAC' not in crypto_policy_module"
  tags:
    - level1-server
    - level1-workstation
    - automated
    - patch
    - crypto
    - NIST800-53R5_SC-8
    - rule_1.6.4
  block:
    - name: "1.6.4 | PATCH | Ensure system wide crypto policy disables macs less than 128 bits | Add submodule exclusion"
      ansible.builtin.template:
        src: etc/crypto-policies/policies/modules/NO-WEAKMAC.pmod.j2
        dest: /etc/crypto-policies/policies/modules/NO-WEAKMAC.pmod
        owner: root
        group: root
        mode: 'u-x,g-wx,o-rwx'
      register: discovered_no_weakmac_template

    - name: "1.6.4 | PATCH | Ensure system wide crypto policy disables macs less than 128 bits | submodule to crypto policy modules"
      ansible.builtin.set_fact:
        crypto_policy_module: "{{ crypto_policy_module + ':' + 'NO-WEAKMAC' }}"
      changed_when: discovered_no_weakmac_template is changed # noqa: no-handler
      notify:
        - Update_Crypto_Policy
        - Set_Crypto_Policy
